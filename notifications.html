<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - The Huddle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           THE HUDDLE: ATELIER DARK (PREMIUM PAPER)
           =========================================
        */
        :root {
            /* --- Paper Palette --- */
            --paper-bg: #1a1918;      
            --paper-card: #242321;    
            --paper-inset: #151413;   
            
            /* --- Ink & Text --- */
            --ink-primary: #f2f0e9;   
            --ink-secondary: #a8a49e; 
            --ink-tertiary: #6b6863;  
            
            /* --- Accents (Matte Terracotta) --- */
            --accent-clay: #e07a5f;
            --accent-clay-dark: #c45f44;
            
            /* --- Status --- */
            --status-success: #81b29a;
            --status-error: #ef4444;
            --status-unread-bg: rgba(224, 122, 95, 0.05);
            --status-unread-border: #e07a5f;
            
            /* --- Dimensionality --- */
            --shadow-card: 1px 1px 0px rgba(255, 255, 255, 0.05) inset, 0 4px 20px rgba(0,0,0,0.4);
            --border-card: 1px solid rgba(255, 255, 255, 0.03);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--paper-bg);
            color: var(--ink-primary);
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        /* --- Header --- */
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .back-btn {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--paper-card);
            border: 1px solid var(--ink-tertiary);
            display: flex; align-items: center; justify-content: center;
            margin-right: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--ink-secondary);
        }

        .back-btn:hover {
            background: var(--paper-inset);
            color: var(--ink-primary);
            border-color: var(--accent-clay);
        }

        .page-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--ink-primary);
            letter-spacing: 0.02em;
        }

        /* --- Notification List --- */
        .notification-list {
            display: flex; flex-direction: column; gap: 1rem;
            padding-bottom: 100px; /* Space for FAB */
        }

        /* --- Notification Card (Thick Stationery) --- */
        .notification-card {
            background: var(--paper-card);
            border-radius: 8px;
            padding: 1.5rem;
            border: var(--border-card);
            box-shadow: var(--shadow-card);
            transition: transform 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .notification-card:hover {
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.1);
        }

        .notification-card.unread {
            background: linear-gradient(90deg, var(--status-unread-bg), var(--paper-card));
            border-left: 3px solid var(--status-unread-border);
        }
        
        .notification-card:not(.unread) { opacity: 0.8; }
        .notification-card:not(.unread):hover { opacity: 1; }

        .notification-header {
            display: flex; align-items: center; margin-bottom: 1rem;
        }

        .notification-avatar {
            width: 42px; height: 42px;
            border-radius: 50%;
            background: var(--paper-inset);
            border: 1px solid var(--ink-tertiary);
            display: flex; align-items: center; justify-content: center;
            color: var(--accent-clay);
            font-weight: 700; font-size: 0.9rem;
            margin-right: 1rem; flex-shrink: 0;
            font-family: 'Playfair Display', serif;
        }

        .notification-info { flex: 1; }

        .notification-name {
            font-weight: 600; margin-bottom: 4px; font-size: 1rem; color: var(--ink-primary);
        }

        .notification-type {
            display: inline-block; padding: 2px 8px;
            background: var(--paper-inset); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 4px; font-size: 0.7rem; color: var(--ink-secondary);
            margin-left: 8px; text-transform: uppercase; letter-spacing: 0.05em;
        }

        .notification-time {
            font-size: 0.8rem; color: var(--ink-tertiary); font-family: 'Inter', sans-serif;
        }

        .notification-content {
            line-height: 1.6; margin-bottom: 1.5rem; color: var(--ink-secondary); font-size: 0.95rem; padding-left: 58px; /* Align with text */
        }

        .notification-actions {
            display: flex; gap: 12px; padding-left: 58px;
        }

        /* --- Buttons (Matte) --- */
        .btn {
            padding: 8px 16px; border-radius: 4px; font-weight: 600; font-size: 0.85rem;
            cursor: pointer; transition: all 0.2s; border: none; font-family: 'Inter';
            text-transform: uppercase; letter-spacing: 0.05em;
        }

        .btn-primary {
            background: var(--accent-clay); color: white;
            box-shadow: 0 2px 0 var(--accent-clay-dark); transform: translateY(0);
        }
        .btn-primary:hover { background: #eb8b70; transform: translateY(-1px); box-shadow: 0 3px 0 var(--accent-clay-dark); }
        
        .btn-secondary {
            background: transparent; color: var(--ink-secondary); border: 1px solid var(--ink-tertiary);
        }
        .btn-secondary:hover { border-color: var(--ink-primary); color: var(--ink-primary); }
        
        .btn-success {
            background: rgba(129, 178, 154, 0.1); color: var(--status-success); border: 1px solid var(--status-success);
        }
        .btn-success:hover { background: var(--status-success); color: var(--paper-bg); }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1); color: var(--status-error); border: 1px solid var(--status-error);
        }
        .btn-danger:hover { background: var(--status-error); color: white; }

        /* --- Mark All Read FAB --- */
        .mark-all-read {
            position: fixed; bottom: 30px; right: 30px;
            padding: 12px 24px; background: var(--paper-card); color: var(--ink-primary);
            border: 1px solid var(--ink-tertiary); border-radius: 50px;
            font-weight: 600; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.3s; z-index: 100; display: none; font-family: 'Inter'; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.85rem;
        }
        .mark-all-read:hover { border-color: var(--accent-clay); color: var(--accent-clay); transform: translateY(-2px); }

        /* --- States --- */
        .empty-state { text-align: center; padding: 80px 20px; color: var(--ink-tertiary); }
        .empty-state i { font-size: 3rem; margin-bottom: 20px; color: var(--paper-inset); text-shadow: 1px 1px 0 rgba(255,255,255,0.05); }
        
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .notification-content, .notification-actions { padding-left: 0; }
            .notification-actions { flex-wrap: wrap; }
            .mark-all-read { width: 90%; bottom: 20px; right: 5%; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" id="backBtn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="page-title">Notifications</h1>
        </div>

        <div class="notification-list" id="notificationList">
            <div style="text-align:center;padding:40px;color:var(--ink-tertiary)">
                <i class="fas fa-circle-notch fa-spin"></i> Loading...
            </div>
        </div>
    </div>

    <button class="mark-all-read" id="markAllReadBtn" onclick="markAllAsRead()">
        Mark All Read
    </button>

    <script>
        const API_URL = window.location.origin;
        let currentUser = null;
        let allNotifications = [];

        window.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('huddleUser');
            if (!userStr || !JSON.parse(userStr).id) {
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = JSON.parse(userStr);
            loadNotifications();
            
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'mainpage.html';
            });
            
            setupNavigation();
        });

        async function loadNotifications() {
            const container = document.getElementById('notificationList');
            
            try {
                const response = await fetch(`${API_URL}/getnotifications?userId=${currentUser.id}`);
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                
                const data = await response.json();
                
                if (data.success && data.notifications) {
                    allNotifications = data.notifications;
                    renderNotifications(allNotifications);
                } else {
                    throw new Error(data.error || 'Failed to parse notifications');
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Unable to load</h3>
                        <p>${escapeHtml(error.message)}</p>
                        <button onclick="loadNotifications()" class="btn btn-secondary" style="margin-top:1rem">Retry</button>
                    </div>
                `;
            }
        }

        function renderNotifications(notifications) {
            const container = document.getElementById('notificationList');
            const readStatus = JSON.parse(localStorage.getItem(`notifications-read-${currentUser.id}`) || '{}');
            
            notifications.forEach(notification => {
                notification.unread = !readStatus[notification.id];
            });
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No notifications</h3>
                        <p>You're all caught up.</p>
                        <button class="btn btn-primary" onclick="window.location.href='mainpage.html'" style="margin-top:1rem">Go Home</button>
                    </div>
                `;
                return;
            }

            notifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            container.innerHTML = notifications.map(notif => {
                const isUnread = notif.unread;
                const typeBadge = notif.type === 'group' ? '<span class="notification-type">Group</span>' : 
                                  notif.type === 'activity' ? '<span class="notification-type">Activity</span>' : 
                                  notif.type === 'join_request' ? '<span class="notification-type" style="color:var(--accent-clay)">Request</span>' :
                                  '<span class="notification-type">Update</span>';

                const timeAgo = getTimeAgo(new Date(notif.createdAt));

                return `
                    <div class="notification-card ${isUnread ? 'unread' : ''}" data-id="${notif.id}">
                        <div class="notification-header">
                            <div class="notification-avatar">${escapeHtml(notif.avatar)}</div>
                            <div class="notification-info">
                                <div class="notification-name">
                                    ${escapeHtml(notif.name)}${typeBadge}
                                </div>
                                <div class="notification-time">${timeAgo}</div>
                            </div>
                        </div>
                        <div class="notification-content">
                            ${escapeHtml(notif.content)}
                        </div>
                        <div class="notification-actions">
                            ${notif.type === 'join_request' ? `
                                <button class="btn btn-success" onclick="acceptJoinRequest('${notif.groupId}','${notif.fromUserId}','${notif.id}')">
                                    Accept
                                </button>
                                <button class="btn btn-danger" onclick="rejectJoinRequest('${notif.groupId}','${notif.fromUserId}','${notif.id}')">
                                    Reject
                                </button>
                            ` : `
                                <button class="btn btn-primary" onclick="viewNotification('${notif.id}', '${notif.actionUrl || ''}')">
                                    ${notif.actionUrl ? 'View' : 'Dismiss'}
                                </button>
                            `}
                            
                            ${isUnread ? `
                                <button class="btn btn-secondary mark-read" data-id="${notif.id}">
                                    Mark Read
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            const unreadCount = notifications.filter(n => n.unread).length;
            const markAllBtn = document.getElementById('markAllReadBtn');
            if (unreadCount > 0) {
                markAllBtn.style.display = 'block';
                markAllBtn.textContent = `Mark All Read (${unreadCount})`;
            } else {
                markAllBtn.style.display = 'none';
            }

            // Re-attach event listeners for dynamic elements
            document.querySelectorAll('.mark-read').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const notificationId = this.getAttribute('data-id');
                    markAsRead(notificationId, e);
                });
            });
        }

        function viewNotification(notificationId, actionUrl) {
            markAsRead(notificationId);
            if (actionUrl) {
                if (actionUrl.includes('mainpage.html') && actionUrl.includes('#group-')) {
                    localStorage.setItem('selectedGroupId', actionUrl.split('#group-')[1]);
                    window.location.href = 'mainpage.html';
                } else {
                    window.location.href = actionUrl;
                }
            }
        }

        function markAsRead(notificationId, event) {
            if (event) event.stopPropagation();
            const notification = allNotifications.find(n => n.id === notificationId);
            if (notification && notification.unread) {
                notification.unread = false;
                const readStatus = JSON.parse(localStorage.getItem(`notifications-read-${currentUser.id}`) || '{}');
                readStatus[notificationId] = true;
                localStorage.setItem(`notifications-read-${currentUser.id}`, JSON.stringify(readStatus));
                renderNotifications(allNotifications);
            }
        }

        function markAllAsRead() {
            const readStatus = JSON.parse(localStorage.getItem(`notifications-read-${currentUser.id}`) || '{}');
            allNotifications.forEach(notification => {
                readStatus[notification.id] = true;
                notification.unread = false;
            });
            localStorage.setItem(`notifications-read-${currentUser.id}`, JSON.stringify(readStatus));
            renderNotifications(allNotifications);
        }

        // --- Join Logic Integration ---
        async function acceptJoinRequest(groupId, userId, notificationId) {
            try {
                const response = await fetch(`${API_URL}/acceptjoinrequest`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ groupId, userId, leaderId: currentUser.id })
                });
                const data = await response.json();
                if (data.success) {
                    alert("User accepted!");
                    // Mark notification as read/handled
                    markAsRead(notificationId);
                    loadNotifications(); 
                } else {
                    alert(data.error || "Error");
                }
            } catch (err) { alert("Network error"); }
        }

        async function rejectJoinRequest(groupId, userId, notificationId) {
            try {
                const response = await fetch(`${API_URL}/rejectjoinrequest`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ groupId, userId, leaderId: currentUser.id })
                });
                const data = await response.json();
                if (data.success) {
                    alert("Request rejected");
                    markAsRead(notificationId);
                    loadNotifications();
                } else {
                    alert(data.error || "Error");
                }
            } catch (err) { alert("Network error"); }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins/60)}h ago`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function setupNavigation() {
            const pageRoutes = {
                'mainpage': 'mainpage.html',
                'profile': 'profile.html',
                'qa': 'qa.html',
                'discuss': 'discuss-room.html',
                'groups': 'group-creationpage.html',
                'notifications': 'notifications.html',
                'chat': 'chatpage.html'
            };
            
            document.querySelectorAll('[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    if (pageRoutes[page]) window.location.href = pageRoutes[page];
                });
            });
        }
    </script>
</body>
</html>
