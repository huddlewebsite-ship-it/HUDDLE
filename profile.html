<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - The Huddle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           THE HUDDLE: ATELIER DARK (PREMIUM PAPER)
           =========================================
        */
        :root {
            /* --- Paper Palette --- */
            --paper-bg: #1a1918;      /* Deep Warm Charcoal */
            --paper-card: #242321;    /* Lighter Charcoal Cardstock */
            --paper-inset: #151413;   /* Deep inset for inputs */
            
            /* --- Ink & Text --- */
            --ink-primary: #f2f0e9;   /* Cream / Off-White */
            --ink-secondary: #a8a49e; /* Warm Grey */
            --ink-tertiary: #6b6863;  /* Deep Grey */
            
            /* --- Accents (Matte Terracotta) --- */
            --accent-clay: #e07a5f;
            --accent-clay-dark: #c45f44;
            
            /* --- Dimensionality --- */
            --shadow-card: 
                1px 1px 0px rgba(255, 255, 255, 0.05) inset, 
                0 10px 40px rgba(0,0,0,0.5);
                
            --border-card: 1px solid rgba(255, 255, 255, 0.03);
            
            /* --- Status --- */
            --status-success: #81b29a;
            --status-error: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--paper-bg);
            color: var(--ink-primary);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
            position: relative;
            overflow-x: hidden;
            /* Subtle paper grain texture */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        }
        
        h1, h2, h3, strong {
            font-family: 'Playfair Display', serif;
            letter-spacing: 0.01em;
        }

        #hero-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.3;
        }

        /* --- Main Container (The Sheet) --- */
        .container {
            width: 100%;
            max-width: 1000px;
            background-color: var(--paper-card);
            border-radius: 8px;
            border: var(--border-card);
            box-shadow: var(--shadow-card);
            overflow: hidden;
            z-index: 10;
            position: relative;
            margin: 2rem 0;
        }

        /* --- Cover Photo --- */
        .cover-photo-container {
            position: relative;
            height: 220px;
            background: var(--paper-inset);
            overflow: hidden;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .cover-photo-container.editable { cursor: pointer; }
        .cover-photo-container.editable:hover { opacity: 0.9; }

        .cover-photo {
            width: 100%; height: 100%; object-fit: cover; display: none;
        }
        .cover-photo.active { display: block; }

        .edit-cover-btn {
            position: absolute; bottom: 15px; right: 15px;
            background: rgba(26, 25, 24, 0.8);
            color: var(--ink-primary);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
            font-family: 'Inter', sans-serif;
        }

        .edit-cover-btn:hover {
            background: var(--accent-clay);
            border-color: var(--accent-clay);
            color: white;
        }

        /* --- Profile Info Header --- */
        .profile-main {
            padding: 0 2.5rem 2.5rem;
            position: relative;
        }

        .profile-header {
            display: flex;
            align-items: flex-end;
            gap: 2rem;
            margin-top: -60px; /* Overlap cover */
            margin-bottom: 3rem;
            position: relative;
        }

        .profile-pic-container { position: relative; flex-shrink: 0; }

        .profile-pic {
            width: 140px; height: 140px;
            border-radius: 50%;
            /* "Cutout" effect border matches container bg */
            border: 6px solid var(--paper-card);
            object-fit: cover;
            background: var(--paper-inset);
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem;
            color: var(--ink-tertiary);
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            z-index: 2;
        }

        .edit-pic-btn {
            position: absolute; bottom: 5px; right: 5px;
            background: var(--paper-card);
            color: var(--ink-primary);
            border: 1px solid var(--ink-tertiary);
            width: 36px; height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
            z-index: 3;
        }

        .edit-pic-btn:hover {
            border-color: var(--accent-clay);
            color: var(--accent-clay);
        }

        .profile-info-header {
            flex: 1;
            padding-bottom: 10px; /* align with bottom of pic */
        }

        .profile-name-container {
            display: flex; align-items: center; gap: 1rem; margin-bottom: 0.25rem;
        }

        .profile-name {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--ink-primary);
            line-height: 1;
        }

        .edit-name-btn {
            background: transparent;
            border: 1px solid var(--ink-tertiary);
            color: var(--ink-secondary);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
            display: flex; align-items: center; gap: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .edit-name-btn:hover {
            border-color: var(--accent-clay);
            color: var(--accent-clay);
        }

        .profile-title {
            font-size: 1rem;
            color: var(--accent-clay);
            margin-bottom: 0;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* --- Grid Layout --- */
        .content-grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr; /* Asymmetric editorial layout */
            gap: 2.5rem;
        }

        /* --- Section Styling --- */
        .section {
            background: transparent; /* Clean look, no box */
            padding: 0;
            margin-bottom: 2.5rem;
            position: relative;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 0.5rem;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--ink-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex; align-items: center; gap: 8px;
            font-family: 'Inter', sans-serif;
        }
        .section-title i { color: var(--accent-clay); }

        .edit-section-btn {
            background: transparent;
            border: none;
            color: var(--ink-tertiary);
            padding: 0;
            cursor: pointer;
            font-size: 0.8rem;
            transition: color 0.2s;
            text-transform: uppercase;
            font-weight: 600;
        }

        .edit-section-btn:hover { color: var(--accent-clay); }

        /* --- Info Data --- */
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.02);
            font-size: 0.95rem;
        }
        
        .info-label { font-weight: 400; color: var(--ink-secondary); }
        .info-value { color: var(--ink-primary); text-align: right; font-weight: 500; }

        .bio-text {
            color: var(--ink-primary);
            line-height: 1.8;
            font-size: 1rem;
            font-weight: 300;
            font-family: 'Inter', sans-serif;
        }

        /* --- Skills --- */
        .skills-grid { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .skill-item {
            background: var(--paper-inset);
            color: var(--ink-primary);
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex; align-items: center; gap: 8px;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .skill-item.editable:hover { border-color: var(--accent-clay); }

        .skill-remove {
            background: transparent; border: none; color: var(--ink-tertiary);
            width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1rem; line-height: 0;
        }
        .skill-remove:hover { color: var(--accent-clay-dark); }

        /* --- Interests --- */
        .interests-grid { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .interest-item {
            background: transparent;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.85rem;
            color: var(--ink-secondary);
            font-weight: 400;
            border: 1px solid var(--ink-tertiary);
        }

        /* --- Socials --- */
        .social-links { display: flex; flex-direction: column; gap: 0.75rem; }
        .social-link {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px;
            background: var(--paper-inset);
            border-radius: 4px;
            text-decoration: none;
            color: var(--ink-primary);
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.02);
        }
        .social-link:hover { border-color: var(--accent-clay); transform: translateX(2px); }
        .social-link span:first-child { font-weight: 600; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .social-link span:first-child i { color: var(--accent-clay); }
        .social-link span:last-child { font-size: 0.85rem; color: var(--ink-tertiary); }

        /* --- Footer Actions --- */
        .action-buttons {
            display: flex; gap: 1rem; padding: 2rem 2.5rem;
            border-top: 1px solid rgba(255,255,255,0.05);
            justify-content: flex-end;
            background: rgba(0,0,0,0.1);
        }

        /* --- Button Styles --- */
        .btn {
            padding: 10px 24px; border: none; border-radius: 4px;
            font-size: 0.9rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 8px;
            text-transform: uppercase; letter-spacing: 0.05em; font-family: 'Inter';
        }

        .btn-primary {
            background: var(--accent-clay); color: white;
            box-shadow: 0 4px 0 var(--accent-clay-dark); transform: translateY(0);
        }
        .btn-primary:hover { background: #eb8b70; transform: translateY(-2px); box-shadow: 0 6px 0 var(--accent-clay-dark); }
        .btn-primary:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--accent-clay-dark); }

        .btn-secondary {
            background: transparent; color: var(--ink-secondary); border: 1px solid var(--ink-tertiary);
        }
        .btn-secondary:hover { color: var(--ink-primary); border-color: var(--ink-primary); }

        .btn-danger {
            background: transparent; border: 1px solid #ef4444; color: #ef4444;
        }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.1); }

        .hidden { display: none !important; }

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(26, 25, 24, 0.95);
            animation: fadeIn 0.2s;
            align-items: center; justify-content: center;
        }
        
        .modal.active { display: flex; }

        .modal-content {
            background-color: var(--paper-card);
            padding: 2.5rem; border-radius: 8px; width: 90%; max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255,255,255,0.05);
            animation: slideUp 0.3s;
        }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem; font-weight: 700; color: var(--ink-primary); font-family: 'Playfair Display';
        }

        .close {
            font-size: 2rem; color: var(--ink-tertiary); cursor: pointer;
            background: none; border: none; line-height: 0.5;
        }
        .close:hover { color: var(--accent-clay); }

        /* --- Form in Modal --- */
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--ink-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }
        
        .form-input, .form-textarea {
            width: 100%; padding: 12px; border: 1px solid transparent;
            border-radius: 4px; font-size: 1rem; font-family: 'Inter', sans-serif;
            color: var(--ink-primary); background: var(--paper-inset);
            outline: none; transition: all 0.2s;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5), inset -1px -1px 0 rgba(255,255,255,0.05);
        }
        
        .form-input:focus, .form-textarea:focus {
            border-color: var(--accent-clay);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.8);
        }
        .form-textarea { resize: vertical; min-height: 120px; line-height: 1.6; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        @media (max-width: 768px) {
            .content-grid { grid-template-columns: 1fr; gap: 0; }
            .profile-header { flex-direction: column; text-align: center; align-items: center; margin-top: -70px; }
            .profile-pic { border-width: 4px; width: 120px; height: 120px; font-size: 2.5rem; }
            .profile-name-container { justify-content: center; }
            .profile-name { font-size: 2rem; }
            .container { border-radius: 0; border: none; margin: 0; box-shadow: none; background: transparent; }
            .profile-main { padding: 0 1rem 1rem; }
            .section { background: var(--paper-card); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.02); }
            .action-buttons { padding: 1rem; background: transparent; border: none; justify-content: center; }
        }
    </style>
</head>
<body>
    <canvas id="hero-canvas"></canvas>

    <div class="container">
        
        <div class="cover-photo-container" id="coverPhotoContainer">
            <img src="" alt="Cover Photo" class="cover-photo" id="coverPhoto">
            <input type="file" id="coverInput" accept="image/*" style="display: none;" onchange="uploadCover(this)">
            <button class="edit-cover-btn hidden">
                <i class="fas fa-camera"></i> Edit Cover
            </button>
        </div>

        <div class="profile-main">
            
            <div class="profile-header">
                <div class="profile-pic-container" id="profilePicContainer">
                    <div class="profile-pic" id="profilePic"></div>
                    <button class="edit-pic-btn hidden">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <input type="file" id="picInput" accept="image/*" style="display: none;" onchange="uploadPic(this)">
                </div>

                <div class="profile-info-header">
                    <div class="profile-name-container">
                        <h1 class="profile-name" id="profileNameDisplay">...</h1>
                        <button class="edit-name-btn hidden" onclick="editNameAndTitle()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <p class="profile-title" id="profileTitleDisplay">...</p>
                </div>
            </div>

            <div class="content-grid">
                <div class="left-col">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title"><i class="fas fa-user"></i> About Me</h2>
                            <button class="edit-section-btn hidden" onclick="editAbout()">Edit</button>
                        </div>
                        <p class="bio-text" id="bioText">Loading...</p>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title"><i class="fas fa-code"></i> Skills</h2>
                            <button class="edit-section-btn hidden" onclick="addSkill()">+ Add</button>
                        </div>
                        <div class="skills-grid" id="skillsGrid"></div>
                    </div>
                    
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title"><i class="fas fa-heart"></i> Interests</h2>
                            <button class="edit-section-btn hidden" onclick="editInterests()">Edit</button>
                        </div>
                        <div class="interests-grid">
                            <div class="interest-item">Design</div>
                            <div class="interest-item">Technology</div>
                            <div class="interest-item">Innovation</div>
                            <div class="interest-item">Collaboration</div>
                        </div>
                    </div>
                </div>

                <div class="right-col">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title"><i class="fas fa-info-circle"></i> Personal Info</h2>
                            <button class="edit-section-btn hidden" onclick="editPersonalInfo()">Edit</button>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value" id="emailValue">...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">University</span>
                            <span class="info-value" id="universityValue">...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Branch</span>
                            <span class="info-value" id="branchValue">...</span>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title"><i class="fas fa-graduation-cap"></i> Academics</h2>
                            <button class="edit-section-btn hidden" onclick="editAcademicInfo()">Edit</button>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Degree</span>
                            <span class="info-value" id="degreeValue">...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Year</span>
                            <span class="info-value" id="academicYearValue">...</span>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title"><i class="fas fa-share-alt"></i> Socials</h2>
                            <button class="edit-section-btn hidden" onclick="editSocialLinks()">Edit</button>
                        </div>
                        <div class="social-links">
                            <a href="#" class="social-link" id="githubLink" target="_blank">
                                <span><i class="fab fa-github"></i> GitHub</span>
                                <span id="githubUsername">...</span>
                            </a>
                            <a href="#" class="social-link" id="linkedinLink" target="_blank">
                                <span><i class="fab fa-linkedin"></i> LinkedIn</span>
                                <span id="linkedinUsername">...</span>
                            </a>
                            <a href="#" class="social-link" id="twitterLink" target="_blank">
                                <span><i class="fab fa-twitter"></i> Twitter</span>
                                <span id="twitterUsername">...</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="window.location.href='mainpage.html'">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="btn btn-primary hidden" onclick="saveProfile()">
                <i class="fas fa-save"></i> Save Profile
            </button>
            <button class="btn btn-danger hidden" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Edit</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;

        function getUserIdForProfile() {
            const params = new URLSearchParams(window.location.search);
            return params.get('userId') || getCurrentLoggedInUserId();
        }

        function getCurrentLoggedInUserId() {
            try {
                const user = JSON.parse(localStorage.getItem('huddleUser') || '{}');
                return user.id || user._id || user.userId || null;
            } catch (e) { return null; }
        }

        async function loadProfileFromDB() {
            const profileUserId = getUserIdForProfile();
            const loggedInUserId = getCurrentLoggedInUserId();
            
            if (!profileUserId) {
                window.location.href = 'login.html';
                return;
            }

            let profileData = null;

            // Logic for Own Profile
            if (profileUserId === loggedInUserId) {
                const savedProfile = localStorage.getItem('huddleProfileData');
                const savedUser = localStorage.getItem('huddleUser');
                profileData = savedProfile ? JSON.parse(savedProfile) : (savedUser ? JSON.parse(savedUser) : null);

                if (profileData) {
                    populateProfile(profileData);
                    toggleEditControls(true);
                } else {
                    window.location.href = 'login.html';
                }
            } 
            // Logic for Other Profile
            else {
                try {
                    const response = await fetch(`${API_URL}/getuser/${profileUserId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.user) {
                            populateProfile(data.user);
                            toggleEditControls(false);
                        } else { throw new Error('Data error'); }
                    } else { throw new Error('User not found'); }
                } catch (error) {
                    console.error(error);
                    showErrorState();
                }
            }
        }

        function showErrorState() {
             document.getElementById('profileNameDisplay').textContent = 'User Not Found';
             document.getElementById('bioText').textContent = 'Could not load profile.';
             toggleEditControls(false);
        }

        function toggleEditControls(isOwner) {
            const buttons = document.querySelectorAll('.edit-cover-btn, .edit-pic-btn, .edit-name-btn, .edit-section-btn, .btn-primary, .btn-danger');
            buttons.forEach(btn => isOwner ? btn.classList.remove('hidden') : btn.classList.add('hidden'));

            const coverInput = document.getElementById('coverInput');
            const picInput = document.getElementById('picInput');
            const coverContainer = document.getElementById('coverPhotoContainer');
            const picContainer = document.getElementById('profilePicContainer');
            
            if (isOwner) {
                coverContainer.classList.add('editable');
                coverContainer.onclick = (e) => { if(e.target.className !== 'edit-cover-btn') coverInput.click(); };
                picContainer.querySelector('.edit-pic-btn').onclick = () => picInput.click();
                document.querySelectorAll('.skill-remove').forEach(btn => btn.classList.remove('hidden'));
                document.querySelectorAll('.skill-item').forEach(item => item.classList.add('editable'));
            } else {
                coverContainer.classList.remove('editable');
                coverContainer.onclick = null;
                picContainer.querySelector('.edit-pic-btn').onclick = null;
                document.querySelectorAll('.skill-remove').forEach(btn => btn.classList.add('hidden'));
                document.querySelectorAll('.skill-item').forEach(item => item.classList.remove('editable'));
            }
        }

        function populateProfile(data) {
            if (data.fullName) {
                document.getElementById('profileNameDisplay').textContent = data.fullName;
                // Initials handling
                const initial = data.fullName.charAt(0).toUpperCase();
                const profilePic = document.getElementById('profilePic');
                if (!data.profilePhotoUrl) profilePic.textContent = initial;
            }

            const title = `${data.branch || ''} Student${data.academicYear ? ` • Year ${data.academicYear}` : ''}`;
            document.getElementById('profileTitleDisplay').textContent = title;
            document.getElementById('bioText').textContent = data.bio || 'No bio yet.';

            if (data.email) document.getElementById('emailValue').textContent = data.email;
            if (data.university) document.getElementById('universityValue').textContent = data.university;
            if (data.branch) document.getElementById('branchValue').textContent = data.branch;
            
            document.getElementById('degreeValue').textContent = 'B.Tech'; 
            if (data.academicYear) document.getElementById('academicYearValue').textContent = data.academicYear;

            // Skills
            const skillsGrid = document.getElementById('skillsGrid');
            skillsGrid.innerHTML = ''; 
            if (data.skills && data.skills.length > 0) {
                data.skills.forEach(skill => {
                    const div = document.createElement('div');
                    div.className = 'skill-item'; 
                    div.innerHTML = `${skill} <button class="skill-remove hidden" onclick="removeSkill(this)">×</button>`;
                    skillsGrid.appendChild(div);
                });
            } else {
                skillsGrid.innerHTML = '<span style="color:var(--ink-tertiary); font-style:italic;">No skills listed.</span>';
            }

            // Photos
            if (data.profilePhotoUrl) {
                const pic = document.getElementById('profilePic');
                pic.style.backgroundImage = `url(${data.profilePhotoUrl})`;
                pic.style.backgroundSize = 'cover';
                pic.textContent = '';
            }
            if (data.coverPhotoUrl) {
                const cover = document.getElementById('coverPhoto');
                cover.src = data.coverPhotoUrl;
                cover.classList.add('active');
            }
        }

        // --- Modals ---
        function editNameAndTitle() {
            const name = document.getElementById('profileNameDisplay').textContent;
            const title = document.getElementById('profileTitleDisplay').textContent;
            showModal('Edit Identity', `
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="editName" value="${name}">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="saveNameAndTitle()">Save</button>
            `);
        }
        
        function saveNameAndTitle() {
            const newName = document.getElementById('editName').value.trim();
            if(newName) document.getElementById('profileNameDisplay').textContent = newName;
            closeModal();
            saveProfile();
        }

        function editAbout() {
            const bio = document.getElementById('bioText').textContent;
            showModal('Edit About', `
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea class="form-textarea" id="editBio">${bio}</textarea>
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="saveBio()">Save</button>
            `);
        }
        
        function saveBio() {
            document.getElementById('bioText').textContent = document.getElementById('editBio').value;
            closeModal();
            saveProfile();
        }

        function editPersonalInfo() {
            const email = document.getElementById('emailValue').textContent;
            const uni = document.getElementById('universityValue').textContent;
            const branch = document.getElementById('branchValue').textContent;
            showModal('Edit Personal', `
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="editEmail" value="${email}"></div>
                <div class="form-group"><label class="form-label">University</label><input type="text" class="form-input" id="editUniversity" value="${uni}"></div>
                <div class="form-group"><label class="form-label">Branch</label><input type="text" class="form-input" id="editBranch" value="${branch}"></div>
                <button class="btn btn-primary" style="width:100%" onclick="savePersonalInfo()">Save</button>
            `);
        }
        
        function savePersonalInfo() {
            document.getElementById('emailValue').textContent = document.getElementById('editEmail').value;
            document.getElementById('universityValue').textContent = document.getElementById('editUniversity').value;
            document.getElementById('branchValue').textContent = document.getElementById('editBranch').value;
            closeModal();
            saveProfile();
        }

        function editAcademicInfo() {
            const deg = document.getElementById('degreeValue').textContent;
            const yr = document.getElementById('academicYearValue').textContent;
            showModal('Edit Academic', `
                <div class="form-group"><label class="form-label">Degree</label><input type="text" class="form-input" id="editDegree" value="${deg}"></div>
                <div class="form-group"><label class="form-label">Year</label><input type="text" class="form-input" id="editYear" value="${yr}"></div>
                <button class="btn btn-primary" style="width:100%" onclick="saveAcademicInfo()">Save</button>
            `);
        }
        
        function saveAcademicInfo() {
            document.getElementById('degreeValue').textContent = document.getElementById('editDegree').value;
            document.getElementById('academicYearValue').textContent = document.getElementById('editYear').value;
            closeModal();
            saveProfile();
        }

        function editSocialLinks() {
            const gh = document.getElementById('githubUsername').textContent;
            const li = document.getElementById('linkedinUsername').textContent;
            const tw = document.getElementById('twitterUsername').textContent;
            showModal('Edit Socials', `
                <div class="form-group"><label class="form-label">GitHub</label><input class="form-input" id="editGithub" value="${gh}"></div>
                <div class="form-group"><label class="form-label">LinkedIn</label><input class="form-input" id="editLinkedin" value="${li}"></div>
                <div class="form-group"><label class="form-label">Twitter</label><input class="form-input" id="editTwitter" value="${tw}"></div>
                <button class="btn btn-primary" style="width:100%" onclick="saveSocialLinks()">Save</button>
            `);
        }
        
        function saveSocialLinks() {
            const gh = document.getElementById('editGithub').value;
            const li = document.getElementById('editLinkedin').value;
            const tw = document.getElementById('editTwitter').value;
            
            document.getElementById('githubUsername').textContent = gh;
            document.getElementById('linkedinUsername').textContent = li;
            document.getElementById('twitterUsername').textContent = tw;
            
            updateSocialLink('githubLink', gh);
            updateSocialLink('linkedinLink', li);
            updateSocialLink('twitterLink', tw);
            closeModal();
        }
        
        function updateSocialLink(id, url) {
            const el = document.getElementById(id);
            if(!url || url === '...') { el.href = '#'; return; }
            el.href = url.startsWith('http') ? url : `https://${url}`;
        }
        
        function editInterests() { alert('Coming soon!'); }

        function addSkill() {
            showModal('Add Skill', `
                <div class="form-group"><label class="form-label">Skill</label><input class="form-input" id="newSkill" placeholder="e.g. Python"></div>
                <button class="btn btn-primary" style="width:100%" onclick="saveSkill()">Add</button>
            `);
        }
        
        function saveSkill() {
            const val = document.getElementById('newSkill').value.trim();
            if(val) {
                const grid = document.getElementById('skillsGrid');
                if(grid.querySelector('span')) grid.innerHTML = '';
                const div = document.createElement('div');
                div.className = 'skill-item editable';
                div.innerHTML = `${val} <button class="skill-remove" onclick="removeSkill(this)">×</button>`;
                grid.appendChild(div);
                closeModal();
                saveProfile();
            }
        }
        
        function removeSkill(btn) { btn.parentElement.remove(); saveProfile(); }

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('editModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // --- Image Uploads ---
        function uploadCover(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('coverPhoto');
                    img.src = e.target.result;
                    img.classList.add('active');
                    saveProfile();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function uploadPic(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.getElementById('profilePic');
                    div.style.backgroundImage = `url(${e.target.result})`;
                    div.style.backgroundSize = 'cover';
                    div.textContent = '';
                    saveProfile();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- Save & Logout ---
        async function saveProfile() {
            const btn = document.querySelector('.btn-primary[onclick="saveProfile()"]');
            if(btn) { btn.disabled = true; btn.innerHTML = 'Saving...'; }
            
            const skills = Array.from(document.querySelectorAll('.skill-item')).map(el => el.textContent.replace('×','').trim());
            const profileData = {
                userId: getCurrentLoggedInUserId(),
                fullName: document.getElementById('profileNameDisplay').textContent,
                bio: document.getElementById('bioText').textContent,
                skills: skills,
                profilePhotoUrl: document.getElementById('profilePic').style.backgroundImage ? document.getElementById('profilePic').style.backgroundImage.slice(5,-2).replace(/"/g, "") : '',
                coverPhotoUrl: document.getElementById('coverPhoto').src || ''
            };

            try {
                const res = await fetch(`${API_URL}/updateprofile`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(profileData)
                });
                const data = await res.json();
                if(res.ok && data.success) {
                    // Update Local Storage
                    const user = JSON.parse(localStorage.getItem('huddleUser') || '{}');
                    const updated = { ...user, ...profileData };
                    localStorage.setItem('huddleUser', JSON.stringify(updated));
                    localStorage.setItem('huddleProfileData', JSON.stringify(updated));
                }
            } catch(e) { console.error(e); }
            
            if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Save Profile'; }
        }

        function logout() {
            localStorage.removeItem('huddleUser');
            localStorage.removeItem('huddleProfileData');
            window.location.href = 'login.html';
        }

        window.onclick = function(e) {
            const m = document.getElementById('editModal');
            if(e.target === m) closeModal();
        }

        document.addEventListener('DOMContentLoaded', loadProfileFromDB);
    </script>
</body>
</html>
